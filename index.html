<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Калькулятор рассрочки</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .calculator { max-width: 400px; margin: auto; }
    .field { margin-bottom: 15px; }
    .field label { font-weight: bold; display: block; margin-bottom: 5px; }
    .field input[type=number] { width: 100%; padding: 5px; font-size: 1em; }
    .slider-container { position: relative; }
    .slider-container input[type=range] { width: 100%; }
    /* Оформление ползунков (WebKit-браузеры) */
    .slider-container input[type=range]::-webkit-slider-thumb { 
      -webkit-appearance: none;
      appearance: none;
      width: 20px; height: 20px;
      background: #4CAF50; /* зелёный бегунок */
      border-radius: 50%;
      cursor: pointer;
      border: none;
      position: relative;
      z-index: 2;
    }
    .slider-container input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 6px;
      background: #ddd;
      border: none;
      border-radius: 3px;
    }
    /* Оформление ползунков (Firefox) */
    .slider-container input[type=range]::-moz-range-thumb {
      width: 20px; height: 20px;
      background: #4CAF50;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }
    .slider-container input[type=range]::-moz-range-track {
      width: 100%; height: 6px;
      background: #ddd;
      border-radius: 3px;
    }
    /* Метка-указатель рекомендуемого значения (магнит) */
    .marker {
      position: absolute;
      width: 10px; height: 10px;
      background: #666;
      border-radius: 50%;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1;
    }
    /* Адаптивность для мобильных */
    @media (max-width: 500px) {
      .calculator { width: 90%; }
    }
  </style>
</head>
<body>
  <div class="calculator">
    <!-- Выбор тарифа -->
    <div class="field">
      <label>Выберите тариф:</label>
      <label><input type="radio" name="tariff" value="with" checked> С первым взносом</label>
      <label style="margin-left: 10px;"><input type="radio" name="tariff" value="without"> Без первого взноса</label>
    </div>
    <!-- Поле ввода стоимости товара -->
    <div class="field">
      <label for="price-input">Стоимость товара:</label>
      <input type="number" id="price-input" value="500000" />
    </div>
    <!-- Ползунок количества месяцев -->
    <div class="field slider-container">
      <label for="months-range">Кол-во месяцев: <span id="months-value">6</span></label>
      <input type="range" id="months-range" min="3" max="24" step="1" value="6" />
    </div>
    <!-- Блок первого взноса (скрывается/удаляется при необходимости) -->
    <div class="field slider-container" id="first-payment-block">
      <label for="initial-range">Первый взнос: <span id="initial-value">0</span> ₽</label>
      <input type="range" id="initial-range" min="0" step="100" value="0" />
      <div class="marker" id="initial-marker" style="display: none;"></div>
    </div>
    <!-- Результаты расчёта -->
    <div class="field">
      <p>Ежемесячный платёж: <span id="monthly-payment">0</span> ₽</p>
      <p>Стоимость с наценкой: <span id="total-cost">0</span> ₽</p>
      <p>Наценка: <span id="markup">0</span> ₽</p>
    </div>
  </div>

  <script>
    (function() {
      // Получение элементов интерфейса
      let firstPaymentBlock = document.getElementById('first-payment-block');
      let initialRange = document.getElementById('initial-range');
      let initialValueDisplay = document.getElementById('initial-value');
      let initialMarker = document.getElementById('initial-marker');
      const priceInput = document.getElementById('price-input');
      const monthsRange = document.getElementById('months-range');
      const monthsValue = document.getElementById('months-value');
      const monthlyPaymentDisplay = document.getElementById('monthly-payment');
      const totalCostDisplay = document.getElementById('total-cost');
      const markupDisplay = document.getElementById('markup');
      const tariffRadios = document.getElementsByName('tariff');
      // Переменная для сохранения последнего значения первого взноса
      let lastInitialValue = initialRange ? parseInt(initialRange.value) : 0;

      // Функция пересчёта и обновления результатов
      function updateCalculations() {
        const price = parseFloat(priceInput.value) || 0;
        const months = parseInt(monthsRange.value) || 0;
        // Если блок первого взноса есть, берем его значение, иначе считаем первый взнос = 0
        let initialPayment = 0;
        if (initialRange && document.body.contains(initialRange)) {
          initialPayment = parseFloat(initialRange.value) || 0;
        }
        // Расчёт наценки в зависимости от месяцев (примерная процентная ставка 14% годовых)
        let markupPercent = (14 / 12) * months;
        if (markupPercent < 0) markupPercent = 0;
        // Общая стоимость с наценкой (до округления платежа)
        let rawTotal = price * (1 + markupPercent / 100);
        // Ежемесячный платёж до округления
        let rawMonthly = (rawTotal - initialPayment) / (months || 1);
        // Округляем ежемесячный платёж вниз до ближайших 100 ₽ для красивого числа
        let monthly = Math.floor(rawMonthly / 100) * 100;
        if (monthly < 0) monthly = 0;
        // Пересчитываем итоговую сумму и наценку с учётом округления
        let totalCost = initialPayment + monthly * (months || 0);
        let markupAmount = totalCost - price;
        if (markupAmount < 0) markupAmount = 0;
        // Обновляем отображение результатов (только суммы в ₽)
        monthlyPaymentDisplay.textContent = monthly.toLocaleString('ru-RU');
        totalCostDisplay.textContent = totalCost.toLocaleString('ru-RU');
        markupDisplay.textContent = markupAmount.toLocaleString('ru-RU');
        // Обновляем отображение значения первого взноса (в тексте метки)
        if (initialValueDisplay) {
          initialValueDisplay.textContent = Math.round(initialPayment).toLocaleString('ru-RU');
        }
        // Обновляем положение метки-рекомендации (25% от totalCost)
        if (initialMarker && document.body.contains(initialMarker)) {
          // Рассчитываем рекомендуемый первый взнос (25% от общей стоимости с наценкой)
          let recommended = 0.25 * totalCost;
          recommended = Math.round(recommended / 100) * 100;
          const minVal = parseFloat(initialRange.min) || 0;
          const maxVal = parseFloat(initialRange.max) || 0;
          if (maxVal > 0) {
            // Вычисляем позицию метки на треке ползунка
            let frac = (recommended - minVal) / (maxVal - minVal);
            if (frac < 0) frac = 0;
            if (frac > 1) frac = 1;
            const sliderWidth = initialRange.offsetWidth;
            const markerX = frac * sliderWidth;
            initialMarker.style.left = markerX + 'px';
            initialMarker.style.display = 'block';
          } else {
            initialMarker.style.display = 'none';
          }
        }
      }

      // Функция "магнитного" эффекта для ползунка первого взноса
      function applyMagnet() {
        if (!initialRange || !document.body.contains(initialRange)) return;
        const price = parseFloat(priceInput.value) || 0;
        const months = parseInt(monthsRange.value) || 0;
        let markupPercent = (14 / 12) * months;
        if (markupPercent < 0) markupPercent = 0;
        let rawTotal = price * (1 + markupPercent / 100);
        // Рассчитываем 25% от общей стоимости (рекомендуемый взнос)
        let recommended = 0.25 * rawTotal;
        recommended = Math.round(recommended / 100) * 100;
        let current = parseFloat(initialRange.value) || 0;
        if (Math.abs(current - recommended) <= 1000) {
          // Притягиваем ползунок к рекомендуемому значению, если он достаточно близко (<= 1000 ₽)
          initialRange.value = recommended;
        }
      }

      // Инициализация значений при загрузке страницы
      if (initialRange) {
        // Устанавливаем максимальный первый взнос равным стоимости товара
        initialRange.max = priceInput.value;
        // Вычисляем рекомендуемый первый взнос (25% от стоимости с наценкой) для стартового значения
        let months = parseInt(monthsRange.value) || 0;
        let markupPercent = (14 / 12) * months;
        if (markupPercent < 0) markupPercent = 0;
        let rawTotal = parseFloat(priceInput.value) * (1 + markupPercent / 100);
        let recommended = Math.round((0.25 * rawTotal) / 100) * 100;
        initialRange.value = recommended;
        if (initialValueDisplay) {
          initialValueDisplay.textContent = Math.round(recommended).toLocaleString('ru-RU');
        }
        lastInitialValue = recommended;
      }
      updateCalculations();  // начальный расчёт

      // Обработчики событий

      // Переключение тарифа (радиокнопки)
      for (let radio of tariffRadios) {
        radio.addEventListener('change', function() {
          if (this.value === 'without') {
            // Тариф без первого взноса: удаляем блок первого взноса из DOM
            if (firstPaymentBlock && document.body.contains(firstPaymentBlock)) {
              if (initialRange) {
                lastInitialValue = parseFloat(initialRange.value) || 0;  // сохраняем текущее значение
              }
              firstPaymentBlock.remove();  // удаляем элемент из DOM [oai_citation:1‡developer.mozilla.org](https://developer.mozilla.org/en-US/docs/Web/API/Element/remove#:~:text=The%20,does%20nothing)
            }
          } else if (this.value === 'with') {
            // Тариф с первым взносом: вставляем блок первого взноса обратно, если его нет
            if (!document.body.contains(firstPaymentBlock)) {
              const monthsContainer = monthsRange.parentNode;
              const fpBlock = document.createElement('div');
              fpBlock.className = 'field slider-container';
              fpBlock.id = 'first-payment-block';
              fpBlock.innerHTML = 
                '<label for="initial-range">Первый взнос: <span id="initial-value">0</span> ₽</label>\
                 <input type="range" id="initial-range" min="0" step="100" value="0">\
                 <div class="marker" id="initial-marker" style="display: none;"></div>';
              // Вставляем блок первого взноса после блока выбора месяцев
              monthsContainer.parentNode.insertBefore(fpBlock, monthsContainer.nextSibling);
              firstPaymentBlock = fpBlock;  // обновляем ссылку на новый блок
              // Обновляем ссылки на элементы внутри нового блока
              initialRange = document.getElementById('initial-range');
              initialValueDisplay = document.getElementById('initial-value');
              initialMarker = document.getElementById('initial-marker');
              // Устанавливаем максимальное значение ползунка (стоимость товара)
              initialRange.max = priceInput.value;
              // Восстанавливаем предыдущее значение первого взноса или рекомендуемое
              let price = parseFloat(priceInput.value) || 0;
              let months = parseInt(monthsRange.value) || 0;
              let markupPercent = (14 / 12) * months;
              if (markupPercent < 0) markupPercent = 0;
              let rawTotal = price * (1 + markupPercent / 100);
              let recommended = Math.round((0.25 * rawTotal) / 100) * 100;
              initialRange.value = lastInitialValue ? lastInitialValue : recommended;
              if (initialValueDisplay) {
                initialValueDisplay.textContent = Math.round(parseFloat(initialRange.value) || 0).toLocaleString('ru-RU');
              }
              // Назначаем обработчик для нового ползунка первого взноса
              initialRange.addEventListener('input', function() {
                initialValueDisplay.textContent = Math.round(parseFloat(this.value)).toLocaleString('ru-RU');
                applyMagnet();
                lastInitialValue = parseFloat(this.value) || 0;
                updateCalculations();
              });
              updateCalculations();  // пересчитываем сразу после добавления блока
            }
          }
          // Пересчитываем результаты при переключении тарифа
          updateCalculations();
        });
      }

      // Изменение стоимости товара
      priceInput.addEventListener('input', function() {
        // Обновляем максимальное значение ползунка первого взноса под новую цену
        if (initialRange && document.body.contains(initialRange)) {
          initialRange.max = this.value;
          // Если текущий первый взнос превышает новую стоимость, корректируем
          if (parseFloat(initialRange.value) > parseFloat(this.value)) {
            initialRange.value = this.value;
            lastInitialValue = parseFloat(this.value) || 0;
          }
        }
        updateCalculations();
      });

      // Изменение количества месяцев (ползунок)
      monthsRange.addEventListener('input', function() {
        monthsValue.textContent = this.value;
        updateCalculations();
      });

      // Изменение первого взноса (ползунок)
      if (initialRange) {
        initialRange.max = priceInput.value;
        initialRange.addEventListener('input', function() {
          initialValueDisplay.textContent = Math.round(parseFloat(this.value)).toLocaleString('ru-RU');
          applyMagnet();
          lastInitialValue = parseFloat(this.value) || 0;
          updateCalculations();
        });
      }
    })();
  </script>
</body>
</html>
