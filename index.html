<script>
  const priceInput = document.getElementById('price');
  const monthsInput = document.getElementById('months');
  const monthsValue = document.getElementById('monthsValue');
  const prepaymentBlock = document.getElementById('prepaymentBlock');
  const prepaymentSlider = document.getElementById('prepaymentSlider');
  const prepaymentLabel = document.getElementById('prepaymentLabel');
  const resultsDiv = document.getElementById('results');
  const whatsappBtn = document.getElementById('whatsapp');
  const errorMessage = document.getElementById('errorMessage');
  const tariffButtons = document.querySelectorAll('.tariff-button');

  let selectedTariff = 'with';
  let conditionalPrepayment = 0;

  const markupWithDown = {3:9,4:12,5:15,6:18,7:20,8:22,9:24,10:26,11:28,12:30};
  const markupWithoutDown = {3:14,4:18,5:23,6:28,7:31,8:33,9:37,10:40,11:43,12:46};

  function roundUpTo100(val) {
    return Math.ceil(val / 100) * 100;
  }

  function togglePrepaymentSlider() {
    prepaymentBlock.style.display = selectedTariff === 'with' ? 'block' : 'none';
  }

  function updateCalculator(resetPrepayment = false) {
    const months = parseInt(monthsInput.value);
    monthsValue.textContent = months;

    let price = parseInt(priceInput.value);
    if (isNaN(price) || price < 50000) {
      errorMessage.style.display = 'block';
      prepaymentLabel.textContent = "0 ₽";
      resultsDiv.innerHTML = `
        <p><strong>Ежемесячный платёж:</strong> 0 ₽</p>
        <p><strong>Стоимость с наценкой:</strong> 0 ₽</p>
        <p><strong>Наценка:</strong> 0 ₽ (0%)</p>
      `;
      whatsappBtn.href = "https://wa.me/79280222114?text=Здравствуйте, хочу оформить рассрочку.";
      togglePrepaymentSlider();
      return;
    } else {
      errorMessage.style.display = 'none';
    }

    const percent = selectedTariff === 'with' ? markupWithDown[months] : markupWithoutDown[months];
    const baseFinalCost = price * (1 + percent / 100);

    let prepayment = 0, monthly = 0, finalCost = 0, message = "";

    if (selectedTariff === 'with') {
      const minPrepayment = roundUpTo100(baseFinalCost * 0.15);
      const maxPrepayment = roundUpTo100(baseFinalCost * 0.65);

      prepaymentSlider.min = minPrepayment;
      prepaymentSlider.max = maxPrepayment;

      conditionalPrepayment = roundUpTo100(baseFinalCost * 0.25);

      if (resetPrepayment) {
        prepaymentSlider.value = conditionalPrepayment;
      }

      if (Math.abs(prepaymentSlider.value - conditionalPrepayment) <= 1500) {
        prepaymentSlider.value = conditionalPrepayment;
      }

      prepayment = parseInt(prepaymentSlider.value);
      prepaymentLabel.textContent = `${prepayment.toLocaleString()} ₽`;

      if (prepayment === conditionalPrepayment) {
        const remaining = baseFinalCost - prepayment;
        monthly = roundUpTo100(remaining / months);
        finalCost = monthly * months + prepayment;
      } else {
        const remaining = price - prepayment;
        const remainingWithMarkup = remaining * (1 + markupWithoutDown[months] / 100);
        monthly = roundUpTo100(remainingWithMarkup / months);
        finalCost = monthly * months + prepayment;
      }

      message = `Здравствуйте, хочу оформить рассрочку. Стоимость товара: ${price.toLocaleString()} ₽, Тариф: С первым взносом, Первый взнос: ${prepayment.toLocaleString()} ₽, Срок: ${months} мес.`;
    } else {
      monthly = roundUpTo100(baseFinalCost / months);
      finalCost = monthly * months;
      prepaymentLabel.textContent = "—";
      message = `Здравствуйте, хочу оформить рассрочку. Стоимость товара: ${price.toLocaleString()} ₽, Тариф: Без первого взноса, Срок: ${months} мес.`;
    }

    const markup = finalCost - price;
    const markupPercent = Math.round((markup / price) * 100);

    resultsDiv.innerHTML = `
      <p><strong>Ежемесячный платёж:</strong> ${monthly.toLocaleString()} ₽</p>
      <p><strong>Стоимость с наценкой:</strong> ${finalCost.toLocaleString()} ₽</p>
      <p><strong>Наценка:</strong> ${markup.toLocaleString()} ₽ (${markupPercent}%)</p>
    `;

    whatsappBtn.href = `https://wa.me/79280222114?text=${encodeURIComponent(message)}`;
    togglePrepaymentSlider();
  }

  tariffButtons.forEach(button => {
    button.addEventListener('click', () => {
      tariffButtons.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      selectedTariff = button.dataset.tariff;
      updateCalculator(true);
    });
  });

  priceInput.addEventListener('input', () => updateCalculator(true));
  monthsInput.addEventListener('input', () => updateCalculator(true));
  prepaymentSlider.addEventListener('input', () => updateCalculator(false));

  updateCalculator(true);
</script>
